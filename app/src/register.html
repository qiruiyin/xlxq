<!DOCTYPE html>
<html lang="en">
<head>
	@@include('./part/head.html')
	<title>注册</title>
	<!-- build:css __STATIC__/css/register.css -->
	<link rel="stylesheet" href="./css/register.css">
	<!-- endbuild -->
</head>
<body>
	<div class="container">
		<div class="logo">
			<img src="./img/logo.png" alt="">
		</div>

		<div class="form">
			<div class="form-td">			
				<label for="">手机号：</label>		
				<input class="mobile" type="text" placeholder="请输入手机号">
				<div class="qrcode">获取验证码</div>
			</div>
			<div class="form-td">			
				<label for="">验证码：</label>		
				<input class="verificationCode" type="number" placeholder="请输入验证码">
			</div>
			<div class="form-td">
				<label for="">密码：</label>		
				<input class="pwd" type="password" placeholder="请输入密码">
			</div>
			<div class="form-td">
				<label for="">邀请码：</label>		
				<input class="invitationCode" type="text" placeholder="请输入邀请码">
			</div>
			<div class="form-td">
				<input class="checkbox" type="checkbox" checked="checked"> <a href="protocol.html">协议</a>
			</div>

			<div class="form-btn">
				<button class="btn">确定</button>
			</div>
		</div>
	</div>

	<!-- Dependencies -->
	<!-- build:js __STATIC__/lib/jquery/jquery.js -->
	<script src="./lib/jquery/dist/jquery.js"></script>
	<!-- endbuild -->
	<!-- build:js __STATIC__/lib/layer/layer.js -->
	<script src="./lib/layer/layer.js"></script>
	<!-- endbuild -->

	<script>
		(function(){
			var t = 59,
					tStatus = false;
			// 验证码倒计时
			function qrcode(time) {
				if(time == 0) {
					tStatus = false;
					$(".qrcode").html("获取验证码");
				} else {
					$(".qrcode").html(time + "秒");
					
					setTimeout(function(){
						qrcode(--time)
					}, 1000);
				}
			}

			function parseToJson (url) {
				if(url != "" && url.indexOf("?") != -1){
					var	url_json = {};
					url = url.replace("#/author", "");
					url = url.split("?");
					url = url[1].split('&');
					for (var i = 0; i<url.length ; i++) {
				    var str = url[i].split('=');
				    url_json[str[0]]=str[1];
					}
					return url_json;
				} else {
					return "";
				}
			}

			var url = parseToJson(location.href);

			$(".invitationCode").val(url.invitationCode);

			$(".qrcode").on("click", function() {
				if(!tStatus) {
					var phoneNumber = $(".mobile").val();
					if(phoneNumber.length != 11) {
						layer.alert("手机号码格式不正确");
						return;
					}

					tStatus = true;
					qrcode(t);
					// 
					$.ajax({
						type: 'POST',
						url: "http://jk.glongcar.com/api/register/getVerificationCode",
					  data: {
					  	phoneNumber: phoneNumber,
					  	type: "1"
					  },
					  success: function(e){ 
					  	if(e.code == 1) {

					  	} else {
					  		layer.alert(e.msg);
					  	}
					  }
		    	});
				}
			});

			$(".btn").on("click", function(){
				var phoneNumber = $(".mobile").val(),
						invitationCode = $(".invitationCode").val(),
						verificationCode = $(".verificationCode").val(),
						pwd = $(".pwd").val(),
						checkbox = $('.checkbox').is(":checked");

				if(phoneNumber.length != 11) {
					layer.alert("手机号码格式不正确");
				} else if(verificationCode == "") {
					layer.alert("验证码不能为空");
				} else if(pwd == "") {
					layer.alert("密码不能为空");
				} else if(!checkbox) {
					layer.alert("请先阅读协议");
				} else {
					$.ajax({
						type: 'POST',
						url: "http://jk.glongcar.com/api/register/checkVerificationCode",
					  data: {
					  	phoneNumber: phoneNumber,
					  	verificationCode: verificationCode,
					  	type: "1"
					  },
						success: function(e){
							if(e.code == 1) {
								$.ajax({
									type: 'POST',
									url: "http://jk.glongcar.com/api/register/submitRegister",
								  data: {
								  	phoneNumber: phoneNumber,
								  	invitationCode: invitationCode,
								  	verificationCode: verificationCode,
								  	pwd: pwd,
								  	openId: "",
								  	type: "1"
								  },
									success: function(e){
										if(e.code == 1) {
											layer.alert(e.msg,
												function() {
											  	location.href = "http://jk.glongcar.com/redirct.html";
											  });
										} else {
											layer.alert(e.msg);
										}
					      	}
					    	});
							} else {
								layer.alert(e.msg);
							}
		      	}
		    	});
				}
			});
		})();
	</script>
</body>
</html>